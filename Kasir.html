<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Form Kasir</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Sora:wght@600;700&display=swap");

      :root {
        --bg: #f3f8ff;
        --panel: #ffffff;
        --line: #d7e3f0;
        --text: #1a2433;
        --sub: #5c6f86;
        --brand: #0f766e;
        --brand-2: #1d4ed8;
        --brand-soft: #e7f5f3;
        --ok: #1f8a46;
        --error: #c92a2a;
        --warn-line: #f0d09a;
        --warn-bg: #fff8e7;
        --shadow: 0 20px 44px rgba(18, 34, 61, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 14px;
        min-height: 100vh;
        color: var(--text);
        font-family: "Plus Jakarta Sans", "Segoe UI", Tahoma, sans-serif;
        background:
          radial-gradient(circle at 10% 10%, rgba(29, 78, 216, 0.14) 0%, transparent 34%),
          radial-gradient(circle at 92% 0%, rgba(15, 118, 110, 0.16) 0%, transparent 36%),
          linear-gradient(180deg, #f9fcff 0%, var(--bg) 64%, #eef7f4 100%);
      }

      .card {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.98), rgba(249, 252, 255, 0.97));
        border: 1px solid var(--line);
        border-radius: 18px;
        padding: 16px;
        box-shadow: var(--shadow);
        position: relative;
        overflow: hidden;
        animation: rise-in 0.45s ease both;
      }

      .card::before {
        content: "";
        position: absolute;
        inset: 0 auto auto 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, var(--brand), var(--brand-2));
      }

      h1 {
        margin: 0;
        font-size: 22px;
        font-family: "Sora", "Plus Jakarta Sans", sans-serif;
        letter-spacing: -0.02em;
      }

      .sub {
        margin-top: 6px;
        color: var(--sub);
        font-size: 12px;
        line-height: 1.45;
      }

      .summary {
        display: grid;
        grid-template-columns: repeat(3, minmax(90px, 1fr));
        gap: 10px;
        margin-top: 14px;
      }

      .summary-box {
        background: linear-gradient(135deg, #ecf8ff, #e8f6f3);
        border: 1px solid #cfe2f5;
        border-radius: 12px;
        padding: 10px;
        box-shadow: 0 10px 24px rgba(15, 42, 72, 0.08);
        animation: rise-in 0.55s ease both;
      }

      .summary-box .k {
        font-size: 11px;
        color: #345677;
      }

      .summary-box .v {
        margin-top: 4px;
        font-size: 18px;
        font-weight: 800;
        color: #113854;
      }

      .form {
        margin-top: 14px;
        display: grid;
        gap: 12px;
      }

      label {
        font-size: 12px;
        font-weight: 600;
        color: var(--sub);
        margin-bottom: 5px;
        display: block;
      }

      input,
      select,
      textarea,
      button {
        width: 100%;
        border-radius: 11px;
        border: 1px solid var(--line);
        padding: 10px 11px;
        font-size: 14px;
        font-family: inherit;
      }

      input,
      select,
      textarea {
        background: #ffffff;
        color: var(--text);
      }

      input[readonly] {
        background: #f2f7ff;
        color: #23486a;
      }

      .checkbox-inline {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0;
      }

      .checkbox-inline input[type='checkbox'] {
        width: 16px;
        height: 16px;
        margin: 0;
        padding: 0;
        border: 1px solid #9ab3d3;
        border-radius: 4px;
        accent-color: #0f766e;
        flex: 0 0 auto;
      }

      .checkbox-inline span {
        font-size: 12px;
        color: var(--sub);
        font-weight: 600;
      }

      .subtotal-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .subtotal-head label {
        margin-bottom: 0;
      }

      .mode-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-width: 62px;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid #c6d7eb;
        background: #eef5ff;
        color: #315b7f;
        font-size: 10px;
        font-weight: 800;
        letter-spacing: 0.5px;
        line-height: 1.4;
      }

      .mode-badge.manual {
        border-color: #9ad7b7;
        background: #e9fbf1;
        color: #0f6b4f;
      }

      .mode-badge.auto {
        border-color: #c6d7eb;
        background: #eef5ff;
        color: #315b7f;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #75a4dc;
        box-shadow: 0 0 0 4px rgba(29, 78, 216, 0.1);
      }

      textarea {
        resize: vertical;
        min-height: 78px;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .product-row {
        display: grid;
        grid-template-columns: minmax(0, 1fr) 130px;
        gap: 10px;
      }

      .qty-row {
        display: grid;
        grid-template-columns: minmax(90px, 130px) minmax(0, 1fr) auto;
        gap: 10px;
        align-items: end;
      }

      .btn {
        cursor: pointer;
        border: 1px solid var(--line);
        background: linear-gradient(135deg, #ffffff, #f4f9ff);
        color: #223247;
        font-weight: 600;
        transition: transform 0.18s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      }

      .btn:hover:not(:disabled) {
        transform: translateY(-1px);
        border-color: #aac2de;
        box-shadow: 0 10px 24px rgba(20, 42, 70, 0.14);
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--brand), #0d9488);
        border-color: #0a766f;
        color: #ffffff;
      }

      .btn-soft {
        background: linear-gradient(135deg, #ebf7ff, #e8f7f3);
        border-color: #bfdff2;
        color: #105271;
      }

      .btn-danger {
        background: linear-gradient(135deg, #fff1f1, #ffeaea);
        border-color: #f4c3c3;
        color: #b42626;
      }

      .btn:disabled {
        cursor: not-allowed;
        opacity: 0.6;
        box-shadow: none;
        transform: none;
      }

      .product-meta {
        border: 1px dashed #bed2e8;
        border-radius: 12px;
        padding: 10px;
        display: grid;
        gap: 7px;
        background: linear-gradient(180deg, #fafdff, #f3f8ff);
      }

      .meta-row {
        display: flex;
        justify-content: space-between;
        gap: 10px;
        font-size: 13px;
      }

      .meta-label {
        color: var(--sub);
      }

      .meta-value {
        font-weight: 700;
      }

      .cart {
        border: 1px solid #cfdbeb;
        border-radius: 12px;
        overflow: hidden;
        background: #ffffff;
        box-shadow: 0 10px 24px rgba(19, 38, 64, 0.08);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      th,
      td {
        border-bottom: 1px solid #ebf1f8;
        padding: 9px 8px;
        text-align: left;
        vertical-align: top;
      }

      th {
        background: #edf4ff;
        color: #3a5674;
        font-weight: 700;
      }

      .cart-empty {
        text-align: center;
        color: var(--sub);
        padding: 14px 10px;
      }

      .line-name {
        font-weight: 700;
      }

      .line-sku {
        font-size: 11px;
        color: var(--sub);
        margin-top: 2px;
      }

      .line-note {
        font-size: 11px;
        color: #6f552e;
        margin-top: 3px;
      }

      .total-box {
        border: 1px solid #bfe0ca;
        background: linear-gradient(135deg, #effcf4, #e9f8ee);
        color: #1d7a36;
        border-radius: 12px;
        padding: 10px;
        display: grid;
        gap: 4px;
        box-shadow: 0 10px 24px rgba(25, 96, 48, 0.1);
      }

      .total-box .k {
        font-size: 12px;
      }

      .total-box .v {
        font-size: 24px;
        font-weight: 800;
      }

      .total-box .mini {
        font-size: 12px;
        color: #2b7b3b;
      }

      .actions {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 8px;
      }

      .stock-section {
        margin-top: 4px;
        border: 1px solid #bfdac7;
        border-radius: 12px;
        background: linear-gradient(135deg, #f2fbf4, #f8fff9);
        padding: 11px;
        display: grid;
        gap: 10px;
      }

      .stock-head {
        font-size: 13px;
        font-weight: 800;
        color: #276c3a;
        letter-spacing: 0.01em;
      }

      .stock-row {
        display: grid;
        grid-template-columns: minmax(0, 1fr) 130px;
        gap: 10px;
      }

      .stock-meta {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        font-size: 12px;
        color: #2a5d37;
      }

      .status {
        margin-top: 12px;
        min-height: 18px;
        font-size: 12px;
        font-weight: 600;
      }

      .status.ok {
        color: var(--ok);
      }

      .status.err {
        color: var(--error);
      }

      .warn {
        margin-top: 10px;
        font-size: 12px;
        color: #8f5c00;
        background: var(--warn-bg);
        border: 1px solid var(--warn-line);
        border-radius: 11px;
        padding: 10px;
        display: none;
      }

      .invoice {
        margin-top: 12px;
        font-size: 12px;
        color: #115062;
        background: linear-gradient(135deg, #e8f8ff, #eaf7f4);
        border: 1px solid #b8deea;
        border-radius: 11px;
        padding: 9px;
        display: none;
      }

      body.sidebar-mode {
        padding: 8px;
      }

      body.sidebar-mode .card {
        border-radius: 14px;
        padding: 11px;
        box-shadow: 0 12px 28px rgba(18, 34, 61, 0.1);
      }

      body.sidebar-mode h1 {
        font-size: 18px;
      }

      body.sidebar-mode .sub {
        font-size: 11px;
        margin-top: 4px;
      }

      body.sidebar-mode .summary {
        margin-top: 10px;
        gap: 7px;
        grid-template-columns: 1fr;
      }

      body.sidebar-mode .summary-box {
        padding: 8px;
      }

      body.sidebar-mode .summary-box .v {
        font-size: 16px;
      }

      body.sidebar-mode .form {
        margin-top: 10px;
        gap: 8px;
      }

      body.sidebar-mode .grid-2,
      body.sidebar-mode .product-row,
      body.sidebar-mode .qty-row,
      body.sidebar-mode .stock-row,
      body.sidebar-mode .actions {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      body.sidebar-mode label {
        font-size: 11px;
        margin-bottom: 3px;
      }

      body.sidebar-mode input,
      body.sidebar-mode select,
      body.sidebar-mode textarea,
      body.sidebar-mode button {
        font-size: 13px;
        padding: 8px 9px;
        border-radius: 10px;
      }

      body.sidebar-mode .product-meta {
        padding: 8px;
        gap: 5px;
      }

      body.sidebar-mode .meta-row {
        font-size: 12px;
      }

      body.sidebar-mode .checkbox-inline input[type='checkbox'] {
        width: 14px;
        height: 14px;
      }

      body.sidebar-mode .checkbox-inline span {
        font-size: 11px;
      }

      body.sidebar-mode .mode-badge {
        min-width: 56px;
        font-size: 9px;
        padding: 2px 7px;
      }

      body.sidebar-mode th,
      body.sidebar-mode td {
        font-size: 12px;
        padding: 7px 6px;
      }

      body.sidebar-mode .total-box {
        padding: 8px;
      }

      body.sidebar-mode .total-box .v {
        font-size: 20px;
      }

      body.sidebar-mode .stock-section {
        margin-top: 2px;
        padding: 8px;
        gap: 8px;
      }

      body.sidebar-mode .stock-head {
        font-size: 12px;
      }

      body.sidebar-mode .status,
      body.sidebar-mode .warn,
      body.sidebar-mode .invoice {
        margin-top: 8px;
      }

      @keyframes rise-in {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 760px) {
        .summary,
        .grid-2,
        .product-row,
        .qty-row,
        .stock-row,
        .actions {
          grid-template-columns: 1fr;
        }

        th:nth-child(3),
        td:nth-child(3) {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Form Kasir</h1>
      <div class="sub">Mode cart aktif: pilih beberapa SKU lalu simpan sekali transaksi dengan nomor invoice.</div>

      <div class="summary">
        <div class="summary-box">
          <div class="k">Transaksi Hari Ini</div>
          <div class="v" id="sumTrx">0</div>
        </div>
        <div class="summary-box">
          <div class="k">Omzet Hari Ini</div>
          <div class="v" id="sumOmzet">Rp0</div>
        </div>
        <div class="summary-box">
          <div class="k">Laba Hari Ini</div>
          <div class="v" id="sumLaba">Rp0</div>
        </div>
      </div>

      <div class="form">
        <div class="grid-2">
          <div>
            <label for="customer">Nama Pelanggan</label>
            <input id="customer" type="text" placeholder="Contoh: Budi" autocomplete="off" />
          </div>
          <div>
            <label for="invoiceNote">Catatan Invoice</label>
            <input id="invoiceNote" type="text" placeholder="Opsional (berlaku untuk transaksi ini)" autocomplete="off" />
          </div>
        </div>

        <div>
          <label for="categoryFilter">Filter Kategori</label>
          <select id="categoryFilter">
            <option value="">Semua Kategori</option>
          </select>
        </div>

        <div class="product-row">
          <div>
            <label for="product">Produk (SKU)</label>
            <select id="product">
              <option value="">Memuat data produk...</option>
            </select>
          </div>
          <div>
            <label for="qty">Qty</label>
            <input id="qty" type="number" min="1" step="1" placeholder="0" />
          </div>
        </div>

        <div class="qty-row">
          <div>
            <label for="itemNote">Catatan Item</label>
            <input id="itemNote" type="text" placeholder="Opsional" autocomplete="off" />
          </div>
          <div>
            <div class="subtotal-head">
              <label for="selectedTotal">Subtotal Item Dipilih</label>
              <span id="priceModeBadge" class="mode-badge auto">AUTO</span>
            </div>
            <input id="selectedTotal" type="text" value="Rp0" placeholder="Aktifkan toggle untuk ubah manual" autocomplete="off" readonly />
            <label class="checkbox-inline" for="manualPriceToggle">
              <input id="manualPriceToggle" type="checkbox" />
              <span>Gunakan harga manual</span>
            </label>
          </div>
          <button id="btnAddItem" class="btn btn-soft" type="button">Tambah ke Keranjang</button>
        </div>

        <div class="product-meta">
          <div class="meta-row"><span class="meta-label">Nama Produk</span><span class="meta-value" id="metaNama">-</span></div>
          <div class="meta-row"><span class="meta-label">Kategori</span><span class="meta-value" id="metaKategori">-</span></div>
          <div class="meta-row"><span class="meta-label">Satuan</span><span class="meta-value" id="metaSatuan">-</span></div>
          <div class="meta-row"><span class="meta-label">Harga Satuan</span><span class="meta-value" id="metaHarga">Rp0</span></div>
          <div class="meta-row"><span class="meta-label">Stok Tersedia</span><span class="meta-value" id="metaStok">0</span></div>
        </div>

        <div class="cart">
          <table>
            <thead>
              <tr>
                <th>Produk</th>
                <th>Qty</th>
                <th>Harga</th>
                <th>Total</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="cartBody"></tbody>
          </table>
        </div>

        <div class="total-box">
          <div class="k">Total Keranjang</div>
          <div class="v" id="cartTotal">Rp0</div>
          <div class="mini">Item: <span id="cartItemsCount">0</span> | Qty: <span id="cartQtyCount">0</span></div>
        </div>

        <div class="actions">
          <button id="btnSave" class="btn btn-primary" type="button">Simpan Transaksi</button>
          <button id="btnReset" class="btn btn-danger" type="button">Kosongkan Keranjang</button>
          <button id="btnReload" class="btn" type="button">Reload</button>
        </div>

        <div class="stock-section">
          <div class="stock-head">Tambah Stok Cepat</div>

          <div class="stock-row">
            <div>
              <label for="stockSku">SKU Produk</label>
              <select id="stockSku">
                <option value="">Memuat data produk...</option>
              </select>
            </div>
            <div>
              <label for="stockQty">Qty Tambah</label>
              <input id="stockQty" type="number" min="1" step="1" placeholder="0" />
            </div>
          </div>

          <div class="grid-2">
            <div>
              <label for="stockNote">Catatan Stok</label>
              <input id="stockNote" type="text" placeholder="Contoh: Restok gudang" autocomplete="off" />
            </div>
            <div>
              <label>Status Stok</label>
              <div class="stock-meta">
                <span>Sekarang: <strong id="stockCurrent">0</strong></span>
                <span>Setelah Tambah: <strong id="stockAfter">0</strong></span>
              </div>
            </div>
          </div>

          <button id="btnStockAdd" class="btn btn-soft" type="button">Simpan Tambah Stok</button>
        </div>
      </div>

      <div class="invoice" id="invoiceInfo"></div>
      <div class="status" id="status"></div>
      <div class="warn" id="warn"></div>
    </div>

    <script>
      let products = [];
      let productMap = {};
      let cartItems = [];
      let selectedManualUnitPrice = null;
      let isLoading = false;

      const API_BASE_STORAGE_KEY = 'paketsembako_api_base';
      const API_BASE = resolveApiBase_();

      function init() {
        applySidebarDensityMode_();
        window.addEventListener('resize', applySidebarDensityMode_);

        document.getElementById('product').addEventListener('change', onProductChange);
        document.getElementById('categoryFilter').addEventListener('change', onCategoryFilterChange_);
        document.getElementById('qty').addEventListener('input', updateSelectedPreview);
        document.getElementById('manualPriceToggle').addEventListener('change', onManualPriceToggleChange_);
        document.getElementById('selectedTotal').addEventListener('input', onSelectedTotalManualInput_);
        document.getElementById('selectedTotal').addEventListener('blur', updateSelectedPreview);
        document.getElementById('btnAddItem').addEventListener('click', addItemToCart);
        document.getElementById('btnSave').addEventListener('click', saveTransaction);
        document.getElementById('btnReset').addEventListener('click', resetCart);
        document.getElementById('btnReload').addEventListener('click', function () {
          loadOptions();
        });
        document.getElementById('stockSku').addEventListener('change', updateStockPreview_);
        document.getElementById('stockQty').addEventListener('input', updateStockPreview_);
        document.getElementById('btnStockAdd').addEventListener('click', saveStockMutationFromForm_);

        if (!isAppsScriptRuntime_() && !API_BASE) {
          setLoading(true);
          setStatus(getMissingApiMessage_(), true);
          renderWarning([
            'Runtime Apps Script tidak terdeteksi.',
            'Mode Netlify membutuhkan endpoint API Apps Script.',
            'Tambahkan query ?apiBase=<URL_WEB_APP_APPS_SCRIPT>/exec pada URL halaman ini.',
          ]);
          return;
        }

        setManualPriceMode_(false);
        renderCart();
        loadOptions();
      }

      function loadOptions(successMessage) {
        setStatus('Memuat data kasir...', false);
        setLoading(true);

        callBackend_(
          'getKasirOptions',
          null,
          function (payload) {
            setLoading(false);
            renderOptions(payload || {});
            setStatus(successMessage || 'Data kasir siap digunakan.', false);
          },
          function (error) {
            setLoading(false);
            setStatus('Gagal memuat data: ' + extractError(error), true);
          }
        );
      }

      function renderOptions(payload) {
        products = payload.products || [];
        productMap = {};
        products.forEach(function (p) {
          productMap[p.sku] = p;
        });

        renderSummary(payload.summary || {});
        renderWarning(payload.meta && payload.meta.warnings ? payload.meta.warnings : []);

        const productSelect = document.getElementById('product');
        const selectedSku = productSelect.value;

        const categorySelect = document.getElementById('categoryFilter');
        const selectedCategory = categorySelect.value;
        const categories = getCategoryOptions_();
        const validSelectedCategory = selectedCategory && categories.indexOf(selectedCategory) > -1
          ? selectedCategory
          : '';

        categorySelect.innerHTML = '';
        const defaultCategoryOption = document.createElement('option');
        defaultCategoryOption.value = '';
        defaultCategoryOption.textContent = 'Semua Kategori';
        categorySelect.appendChild(defaultCategoryOption);

        categories.forEach(function (kategori) {
          const opt = document.createElement('option');
          opt.value = kategori;
          opt.textContent = kategori;
          categorySelect.appendChild(opt);
        });
        categorySelect.value = validSelectedCategory;

        renderProductOptionsByCategory_(validSelectedCategory, selectedSku);

        const stockSelect = document.getElementById('stockSku');
        const selectedStockSku = stockSelect.value;
        stockSelect.innerHTML = '';

        const stockDefault = document.createElement('option');
        stockDefault.value = '';
        stockDefault.textContent = products.length ? 'Pilih SKU untuk tambah stok' : 'Produk tidak tersedia';
        stockSelect.appendChild(stockDefault);

        products.forEach(function (item) {
          const opt = document.createElement('option');
          opt.value = item.sku;
          opt.textContent = item.sku + ' - ' + item.namaProduk;
          stockSelect.appendChild(opt);
        });

        if (selectedStockSku && productMap[selectedStockSku]) {
          stockSelect.value = selectedStockSku;
        } else if (selectedSku && productMap[selectedSku]) {
          stockSelect.value = selectedSku;
        }

        refreshCartPricingFromCatalog_();
        onProductChange();
        updateStockPreview_();
      }

      function onCategoryFilterChange_() {
        const filterValue = document.getElementById('categoryFilter').value;
        const currentSku = document.getElementById('product').value;
        renderProductOptionsByCategory_(filterValue, currentSku);
        onProductChange();
      }

      function getCategoryOptions_() {
        const seen = {};
        const categories = [];

        products.forEach(function (item) {
          const kategori = normalizeCategoryLabel_(item && item.kategori) || 'Tanpa Kategori';
          if (!seen[kategori]) {
            seen[kategori] = true;
            categories.push(kategori);
          }
        });

        categories.sort(function (a, b) {
          return a.localeCompare(b, 'id');
        });
        return categories;
      }

      function getFilteredProductsByCategory_(categoryValue) {
        const kategori = normalizeCategoryLabel_(categoryValue);
        if (!kategori) {
          return products.slice();
        }

        return products.filter(function (item) {
          const itemCategory = normalizeCategoryLabel_(item && item.kategori) || 'Tanpa Kategori';
          return itemCategory === kategori;
        });
      }

      function renderProductOptionsByCategory_(categoryValue, preferredSku) {
        const select = document.getElementById('product');
        const filteredProducts = getFilteredProductsByCategory_(categoryValue);

        select.innerHTML = '';
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = filteredProducts.length
          ? 'Pilih SKU / Produk'
          : 'Produk tidak tersedia pada kategori ini';
        select.appendChild(defaultOption);

        filteredProducts.forEach(function (item) {
          const opt = document.createElement('option');
          opt.value = item.sku;
          opt.textContent = item.sku + ' - ' + item.namaProduk + ' (stok: ' + formatNumber(item.stokTersedia) + ')';
          select.appendChild(opt);
        });

        const preferredExists = filteredProducts.some(function (item) {
          return item.sku === preferredSku;
        });
        select.value = preferredExists ? preferredSku : '';
      }

      function renderSummary(summary) {
        document.getElementById('sumTrx').textContent = formatNumber(summary.transaksiHariIni || 0);
        document.getElementById('sumOmzet').textContent = formatCurrency(summary.omzetHariIni || 0);
        document.getElementById('sumLaba').textContent = formatCurrency(summary.labaHariIni || 0);
      }

      function renderWarning(warnings) {
        const box = document.getElementById('warn');
        if (!warnings || !warnings.length) {
          box.style.display = 'none';
          box.textContent = '';
          return;
        }

        box.style.display = 'block';
        box.innerHTML = warnings.map(function (w) { return '- ' + escapeHtml(w); }).join('<br>');
      }

      function onProductChange() {
        const sku = document.getElementById('product').value;
        const item = productMap[sku];
        setManualPriceMode_(false);
        if (!item) {
          clearProductMeta();
          return;
        }

        document.getElementById('metaNama').textContent = item.namaProduk || '-';
        document.getElementById('metaKategori').textContent = item.kategori || '-';
        document.getElementById('metaSatuan').textContent = item.satuan || '-';
        document.getElementById('metaHarga').textContent = formatCurrency(item.hargaJual || 0);
        document.getElementById('metaStok').textContent = formatNumber(item.stokTersedia || 0);

        updateSelectedPreview();
      }

      function clearProductMeta() {
        setManualPriceMode_(false);
        document.getElementById('metaNama').textContent = '-';
        document.getElementById('metaKategori').textContent = '-';
        document.getElementById('metaSatuan').textContent = '-';
        document.getElementById('metaHarga').textContent = 'Rp0';
        document.getElementById('metaStok').textContent = '0';
        document.getElementById('selectedTotal').value = 'Rp0';
      }

      function updateSelectedPreview() {
        const sku = document.getElementById('product').value;
        const item = productMap[sku];
        const qty = Number(document.getElementById('qty').value || 0);
        const defaultHarga = round2(Number(item && item.hargaJual) || 0);
        const useManualPrice = isManualPriceEnabled_();

        if (!item || !qty || qty <= 0) {
          document.getElementById('selectedTotal').value = 'Rp0';
          return;
        }

        if (useManualPrice && (selectedManualUnitPrice === null || selectedManualUnitPrice === undefined)) {
          selectedManualUnitPrice = defaultHarga;
        }

        const hargaSatuan = useManualPrice
          ? Math.max(0, round2(Number(selectedManualUnitPrice) || 0))
          : defaultHarga;
        const total = round2(hargaSatuan * qty);
        document.getElementById('selectedTotal').value = formatCurrency(total);
      }

      function isManualPriceEnabled_() {
        const toggle = document.getElementById('manualPriceToggle');
        return !!(toggle && toggle.checked);
      }

      function setManualPriceMode_(enabled) {
        const toggle = document.getElementById('manualPriceToggle');
        const subtotalInput = document.getElementById('selectedTotal');
        const isEnabled = !!enabled;

        if (toggle) {
          toggle.checked = isEnabled;
        }
        if (subtotalInput) {
          subtotalInput.readOnly = !isEnabled;
        }
        updatePriceModeBadge_(isEnabled);
        if (!isEnabled) {
          selectedManualUnitPrice = null;
        }
      }

      function updatePriceModeBadge_(isManual) {
        const badge = document.getElementById('priceModeBadge');
        if (!badge) {
          return;
        }

        if (isManual) {
          badge.textContent = 'MANUAL';
          badge.classList.remove('auto');
          badge.classList.add('manual');
          return;
        }

        badge.textContent = 'AUTO';
        badge.classList.remove('manual');
        badge.classList.add('auto');
      }

      function onManualPriceToggleChange_() {
        const enabled = isManualPriceEnabled_();
        setManualPriceMode_(enabled);
        updateSelectedPreview();
      }

      function onSelectedTotalManualInput_() {
        if (!isManualPriceEnabled_()) {
          return;
        }

        const sku = document.getElementById('product').value;
        const item = productMap[sku];
        const qty = Number(document.getElementById('qty').value || 0);
        const inputEl = document.getElementById('selectedTotal');
        const rawValue = String(inputEl.value || '').trim();

        if (!item || !qty || qty <= 0) {
          selectedManualUnitPrice = null;
          return;
        }

        if (!rawValue) {
          selectedManualUnitPrice = null;
          return;
        }

        const subtotalManual = round2(parseCurrencyNumber_(rawValue));
        if (subtotalManual < 0) {
          return;
        }

        selectedManualUnitPrice = round2(subtotalManual / qty);
      }

      function addItemToCart() {
        const sku = document.getElementById('product').value;
        const qty = Number(document.getElementById('qty').value || 0);
        const itemNote = document.getElementById('itemNote').value.trim();
        const item = productMap[sku];

        if (!item) {
          setStatus('Pilih SKU terlebih dahulu.', true);
          return;
        }

        if (!qty || qty <= 0) {
          setStatus('Qty harus lebih dari 0.', true);
          return;
        }

        const stokTersedia = Number(item.stokTersedia) || 0;
        const qtyInCart = getCartQtyBySku_(sku);
        if (qtyInCart + qty > stokTersedia) {
          setStatus(
            'Stok tidak cukup. Maksimal untuk ' + item.namaProduk + ' adalah ' + formatNumber(Math.max(0, stokTersedia - qtyInCart)),
            true
          );
          return;
        }

        const hargaMaster = round2(Number(item.hargaJual) || 0);
        const useManualPrice = isManualPriceEnabled_();
        const hasManualUnitPrice = useManualPrice && !(selectedManualUnitPrice === null || selectedManualUnitPrice === undefined);
        const hargaManual = hasManualUnitPrice
          ? Math.max(0, round2(Number(selectedManualUnitPrice) || 0))
          : hargaMaster;
        const hargaSatuan = round2(hargaManual);
        const isManualHarga = hasManualUnitPrice;

        const existing = cartItems.find(function (row) {
          return row.sku === sku && round2(Number(row.hargaSatuan) || 0) === hargaSatuan;
        });
        if (existing) {
          existing.qty = round2(existing.qty + qty);
          if (isManualHarga) {
            existing.isManualHarga = true;
          }
          if (itemNote) {
            existing.note = itemNote;
          }
        } else {
          cartItems.push({
            sku: item.sku,
            namaProduk: item.namaProduk,
            satuan: item.satuan,
            hargaSatuan: hargaSatuan,
            isManualHarga: isManualHarga,
            qty: round2(qty),
            note: itemNote,
          });
        }

        setManualPriceMode_(false);
        document.getElementById('qty').value = '';
        document.getElementById('itemNote').value = '';
        updateSelectedPreview();
        renderCart();
        setStatus('Item ditambahkan ke keranjang.', false);
      }

      function removeCartItem(index) {
        if (index < 0 || index >= cartItems.length) {
          return;
        }
        cartItems.splice(index, 1);
        renderCart();
        setStatus('Item dihapus dari keranjang.', false);
      }

      function resetCart() {
        if (!cartItems.length) {
          return;
        }
        cartItems = [];
        renderCart();
        setStatus('Keranjang dikosongkan.', false);
      }

      function renderCart() {
        const tbody = document.getElementById('cartBody');
        tbody.innerHTML = '';

        if (!cartItems.length) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 5;
          td.className = 'cart-empty';
          td.textContent = 'Keranjang kosong. Tambahkan item di atas.';
          tr.appendChild(td);
          tbody.appendChild(tr);
          updateCartTotals_();
          updateActionState_();
          return;
        }

        cartItems.forEach(function (item, index) {
          const tr = document.createElement('tr');

          const total = round2((Number(item.hargaSatuan) || 0) * (Number(item.qty) || 0));
          const noteHtml = item.note ? '<div class="line-note">Catatan: ' + escapeHtml(item.note) + '</div>' : '';
          const manualPriceHtml = item.isManualHarga ? '<div class="line-note">Harga manual</div>' : '';

          tr.innerHTML =
            '<td><div class="line-name">' + escapeHtml(item.namaProduk || item.sku) + '</div>' +
            '<div class="line-sku">' + escapeHtml(item.sku) + ' · ' + escapeHtml(item.satuan || '-') + '</div>' +
            noteHtml +
            '</td>' +
            '<td>' + formatNumber(item.qty || 0) + '</td>' +
            '<td>' + formatCurrency(item.hargaSatuan || 0) + manualPriceHtml + '</td>' +
            '<td>' + formatCurrency(total) + '</td>' +
            '<td><button class="btn btn-danger" type="button" data-index="' + index + '">Hapus</button></td>';

          tbody.appendChild(tr);
        });

        Array.prototype.forEach.call(tbody.querySelectorAll('button[data-index]'), function (btn) {
          btn.addEventListener('click', function () {
            removeCartItem(Number(btn.getAttribute('data-index')));
          });
        });

        updateCartTotals_();
        updateActionState_();
      }

      function updateCartTotals_() {
        const totalQty = round2(
          cartItems.reduce(function (sum, item) {
            return sum + (Number(item.qty) || 0);
          }, 0)
        );
        const totalBelanja = round2(
          cartItems.reduce(function (sum, item) {
            return sum + (Number(item.qty) || 0) * (Number(item.hargaSatuan) || 0);
          }, 0)
        );

        document.getElementById('cartItemsCount').textContent = formatNumber(cartItems.length);
        document.getElementById('cartQtyCount').textContent = formatNumber(totalQty);
        document.getElementById('cartTotal').textContent = formatCurrency(totalBelanja);
      }

      function saveTransaction() {
        const customer = document.getElementById('customer').value.trim();
        const invoiceNote = document.getElementById('invoiceNote').value.trim();

        if (!customer) {
          setStatus('Nama pelanggan wajib diisi.', true);
          return;
        }
        if (!cartItems.length) {
          setStatus('Keranjang masih kosong.', true);
          return;
        }

        const payload = {
          customerName: customer,
          note: invoiceNote,
          items: cartItems.map(function (item) {
            return {
              sku: item.sku,
              qty: item.qty,
              hargaSatuan: Number(item.hargaSatuan) || 0,
              note: item.note || '',
            };
          }),
        };

        setStatus('Menyimpan transaksi...', false);
        setLoading(true);

        callBackend_(
          'saveKasirTransaction',
          payload,
          function (res) {
            setLoading(false);
            const trx = (res && res.transaksi) || {};
            const invoice = trx.invoice || '-';

            showInvoiceInfo_('Invoice ' + invoice + ' berhasil disimpan. Total: ' + formatCurrency(trx.total || 0));
            setStatus((res && res.message) || 'Transaksi berhasil disimpan.', false);

            cartItems = [];
            document.getElementById('qty').value = '';
            document.getElementById('itemNote').value = '';
            document.getElementById('invoiceNote').value = '';
            renderCart();
            loadOptions((res && res.message) || 'Transaksi berhasil disimpan.');
          },
          function (error) {
            setLoading(false);
            setStatus('Gagal menyimpan: ' + extractError(error), true);
          }
        );
      }

      function updateStockPreview_() {
        const sku = document.getElementById('stockSku').value;
        const item = productMap[sku];
        const qty = Number(document.getElementById('stockQty').value || 0);

        const currentStock = item ? Number(item.stokTersedia) || 0 : 0;
        const nextStock = item && qty > 0 ? round2(currentStock + qty) : currentStock;
        const unit = item && item.satuan ? ' ' + item.satuan : '';

        document.getElementById('stockCurrent').textContent = formatNumber(currentStock) + unit;
        document.getElementById('stockAfter').textContent = formatNumber(nextStock) + unit;
      }

      function saveStockMutationFromForm_() {
        const sku = document.getElementById('stockSku').value;
        const qty = Number(document.getElementById('stockQty').value || 0);
        const note = document.getElementById('stockNote').value.trim();

        if (!sku) {
          setStatus('Pilih SKU produk untuk tambah stok.', true);
          return;
        }
        if (!qty || qty <= 0) {
          setStatus('Qty tambah stok harus lebih dari 0.', true);
          return;
        }

        setStatus('Menyimpan penambahan stok...', false);
        setLoading(true);

        callBackend_(
          'saveStockMutation',
          {
            type: 'MASUK',
            sku: sku,
            qty: qty,
            note: note,
          },
          function (res) {
            const productName = (res && res.namaProduk) || sku;
            const stockAfter = res && typeof res.stokSetelah !== 'undefined'
              ? formatNumber(res.stokSetelah)
              : '-';

            document.getElementById('stockQty').value = '';
            document.getElementById('stockNote').value = '';
            loadOptions('Tambah stok berhasil untuk ' + productName + '. Stok baru: ' + stockAfter + '.');
          },
          function (error) {
            setLoading(false);
            setStatus('Gagal menambah stok: ' + extractError(error), true);
          }
        );
      }

      function showInvoiceInfo_(message) {
        const box = document.getElementById('invoiceInfo');
        if (!message) {
          box.style.display = 'none';
          box.textContent = '';
          return;
        }

        box.style.display = 'block';
        box.textContent = message;
      }

      function refreshCartPricingFromCatalog_() {
        if (!cartItems.length) {
          return;
        }

        let adjusted = false;

        cartItems = cartItems
          .map(function (item) {
            const master = productMap[item.sku];
            if (!master) {
              adjusted = true;
              return null;
            }

            const latestStock = Number(master.stokTersedia) || 0;
            const safeQty = Math.min(round2(item.qty), latestStock);
            if (!safeQty) {
              adjusted = true;
              return null;
            }
            if (safeQty !== round2(item.qty)) {
              adjusted = true;
            }

            const latestPrice = round2(Number(master.hargaJual) || 0);
            const previousPrice = round2(Number(item.hargaSatuan) || 0);
            const keepManualPrice = !!item.isManualHarga;
            const safeManualPrice = previousPrice >= 0 ? previousPrice : latestPrice;
            const hargaSatuan = keepManualPrice ? safeManualPrice : latestPrice;
            if (!keepManualPrice && previousPrice !== latestPrice) {
              adjusted = true;
            }

            return {
              sku: item.sku,
              namaProduk: master.namaProduk,
              satuan: master.satuan,
              hargaSatuan: hargaSatuan,
              isManualHarga: keepManualPrice,
              qty: safeQty,
              note: item.note || '',
            };
          })
          .filter(function (item) {
            return !!item;
          });

        renderCart();
        if (adjusted) {
          setStatus('Keranjang disesuaikan dengan stok terbaru.', false);
        }
      }

      function getCartQtyBySku_(sku) {
        return round2(
          cartItems.reduce(function (sum, item) {
            return sum + (item.sku === sku ? Number(item.qty) || 0 : 0);
          }, 0)
        );
      }

      function callBackend_(functionName, payload, onSuccess, onFailure) {
        if (isAppsScriptRuntime_()) {
          callAppsScript_(functionName, payload, onSuccess, onFailure);
          return;
        }

        const success = typeof onSuccess === 'function' ? onSuccess : function () {};
        const failure = typeof onFailure === 'function' ? onFailure : function () {};

        if (!API_BASE) {
          failure(new Error(getMissingApiMessage_()));
          return;
        }

        callApi_(functionName, payload).then(success).catch(failure);
      }

      function callApi_(functionName, payload) {
        if (functionName === 'getKasirOptions') {
          return fetchApi_('kasir-options', 'GET');
        }
        if (functionName === 'saveKasirTransaction') {
          return fetchApi_('save-transaction', 'POST', payload || {});
        }
        if (functionName === 'saveStockMutation') {
          return fetchApi_('save-stock-mutation', 'POST', payload || {});
        }
        return Promise.reject(new Error('Fungsi backend tidak dikenali: ' + functionName));
      }

      async function fetchApi_(action, method, payload) {
        const url = new URL(API_BASE);
        url.searchParams.set('action', action);

        const options = {
          method: method,
          cache: 'no-store',
        };

        if (method === 'POST') {
          options.headers = { 'Content-Type': 'text/plain;charset=utf-8' };
          options.body = JSON.stringify(payload || {});
        }

        const response = await fetch(url.toString(), options);
        let json;

        try {
          json = await response.json();
        } catch (err) {
          throw new Error('Respons API tidak valid (bukan JSON).');
        }

        if (!response.ok) {
          throw new Error('HTTP ' + response.status + ' ' + response.statusText);
        }

        if (!json || json.ok !== true) {
          throw new Error((json && json.error) || 'Permintaan API gagal.');
        }

        return json.data;
      }

      function resolveApiBase_() {
        const queryApi = sanitizeApiBase_(new URL(window.location.href).searchParams.get('apiBase'));
        if (queryApi) {
          try {
            localStorage.setItem(API_BASE_STORAGE_KEY, queryApi);
          } catch (err) {
            // Abaikan jika storage tidak tersedia.
          }
          return queryApi;
        }

        const windowApi = sanitizeApiBase_(window.APP_API_BASE);
        if (windowApi) {
          try {
            localStorage.setItem(API_BASE_STORAGE_KEY, windowApi);
          } catch (err) {
            // Abaikan jika storage tidak tersedia.
          }
          return windowApi;
        }

        try {
          return sanitizeApiBase_(localStorage.getItem(API_BASE_STORAGE_KEY));
        } catch (err) {
          return '';
        }
      }

      function sanitizeApiBase_(value) {
        const text = value === null || value === undefined ? '' : String(value).trim();
        if (!text) {
          return '';
        }
        return text.replace(/\/+$/, '');
      }

      function getMissingApiMessage_() {
        return 'API endpoint belum diset. Tambahkan ?apiBase=<URL_WEB_APP_APPS_SCRIPT>/exec pada URL halaman Kasir.';
      }

      function applySidebarDensityMode_() {
        const sidebarFlag = new URL(window.location.href).searchParams.get('sidebarDensity');
        let enabled;

        if (sidebarFlag === '1' || sidebarFlag === 'true') {
          enabled = true;
        } else if (sidebarFlag === '0' || sidebarFlag === 'false') {
          enabled = false;
        } else {
          enabled = isAppsScriptRuntime_() && window.innerWidth <= 430;
        }

        document.body.classList.toggle('sidebar-mode', enabled);
      }

      function isAppsScriptRuntime_() {
        return (
          typeof google !== 'undefined' &&
          google &&
          google.script &&
          google.script.run
        );
      }

      function callAppsScript_(functionName, payload, onSuccess, onFailure) {
        if (!isAppsScriptRuntime_()) {
          onFailure(new Error('google.script.run tidak tersedia pada context ini.'));
          return;
        }

        const success = typeof onSuccess === 'function' ? onSuccess : function () {};
        const failure = typeof onFailure === 'function' ? onFailure : function () {};
        const runner = google.script.run
          .withSuccessHandler(success)
          .withFailureHandler(failure);

        if (typeof runner[functionName] !== 'function') {
          failure(new Error('Fungsi server tidak ditemukan: ' + functionName));
          return;
        }

        if (payload === null || payload === undefined) {
          runner[functionName]();
        } else {
          runner[functionName](payload);
        }
      }

      function setLoading(loading) {
        isLoading = !!loading;
        updateActionState_();
      }

      function updateActionState_() {
        document.getElementById('btnAddItem').disabled = isLoading;
        document.getElementById('btnReload').disabled = isLoading;
        document.getElementById('btnReset').disabled = isLoading || !cartItems.length;
        document.getElementById('btnSave').disabled = isLoading || !cartItems.length;
        document.getElementById('btnStockAdd').disabled = isLoading;
      }

      function setStatus(message, isError) {
        const el = document.getElementById('status');
        el.textContent = message || '';
        el.className = 'status ' + (isError ? 'err' : 'ok');
      }

      function extractError(error) {
        if (!error) {
          return 'Unknown error';
        }
        return error.message || String(error);
      }

      function formatCurrency(value) {
        return new Intl.NumberFormat('id-ID', {
          style: 'currency',
          currency: 'IDR',
          maximumFractionDigits: 0,
        }).format(Number(value) || 0);
      }

      function parseCurrencyNumber_(value) {
        if (typeof value === 'number') {
          return Number.isFinite(value) ? value : 0;
        }

        if (value === null || value === undefined || value === '') {
          return 0;
        }

        let text = String(value)
          .replace(/\s+/g, '')
          .replace(/[^0-9,.-]/g, '');

        if (!text) {
          return 0;
        }

        const hasComma = text.indexOf(',') > -1;
        const hasDot = text.indexOf('.') > -1;

        if (hasComma && hasDot) {
          if (text.lastIndexOf(',') > text.lastIndexOf('.')) {
            text = text.replace(/\./g, '').replace(',', '.');
          } else {
            text = text.replace(/,/g, '');
          }
        } else if (hasComma && !hasDot) {
          const parts = text.split(',');
          if (parts.length === 2 && parts[1].length <= 2) {
            text = parts[0].replace(/\./g, '') + '.' + parts[1];
          } else {
            text = text.replace(/,/g, '');
          }
        } else if (hasDot && !hasComma) {
          const parts = text.split('.');
          const looksLikeThousands = parts.length > 1 && parts.slice(1).every(function (part) {
            return part.length === 3;
          });
          text = looksLikeThousands ? parts.join('') : text;
        } else {
          text = text.replace(/,/g, '');
        }

        const num = parseFloat(text);
        return Number.isFinite(num) ? num : 0;
      }

      function normalizeCategoryLabel_(value) {
        const text = value === null || value === undefined ? '' : String(value).trim();
        return text || '';
      }

      function formatNumber(value) {
        return new Intl.NumberFormat('id-ID', {
          maximumFractionDigits: 2,
        }).format(Number(value) || 0);
      }

      function round2(value) {
        return Math.round((Number(value) + Number.EPSILON) * 100) / 100;
      }

      function escapeHtml(text) {
        return String(text)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>

