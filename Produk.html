<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manajemen Produk</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Sora:wght@600;700&display=swap");

      :root {
        --bg: #f2f8ff;
        --panel: #ffffff;
        --line: #d6e3f2;
        --text: #1a2535;
        --sub: #5b6f87;
        --brand: #0f766e;
        --brand-2: #1e40af;
        --ok: #1f8a46;
        --error: #c92a2a;
        --warn-bg: #fff8e7;
        --warn-line: #efd09a;
        --shadow: 0 20px 46px rgba(18, 35, 62, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 14px;
        color: var(--text);
        font-family: "Plus Jakarta Sans", "Segoe UI", Tahoma, sans-serif;
        background:
          radial-gradient(circle at 9% 8%, rgba(30, 64, 175, 0.14) 0%, transparent 35%),
          radial-gradient(circle at 90% 0%, rgba(15, 118, 110, 0.15) 0%, transparent 38%),
          linear-gradient(180deg, #f9fcff 0%, var(--bg) 64%, #edf8f4 100%);
      }

      .card {
        background: linear-gradient(180deg, rgba(255, 255, 255, 0.98), rgba(248, 252, 255, 0.97));
        border: 1px solid var(--line);
        border-radius: 18px;
        padding: 16px;
        position: relative;
        overflow: hidden;
        box-shadow: var(--shadow);
        animation: rise-in 0.45s ease both;
      }

      .card::before {
        content: "";
        position: absolute;
        inset: 0 auto auto 0;
        width: 100%;
        height: 4px;
        background: linear-gradient(90deg, var(--brand), var(--brand-2));
      }

      h1 {
        margin: 0;
        font-size: 23px;
        font-family: "Sora", "Plus Jakarta Sans", sans-serif;
        letter-spacing: -0.02em;
      }

      .sub {
        margin-top: 6px;
        color: var(--sub);
        font-size: 12px;
        line-height: 1.45;
      }

      .summary {
        display: grid;
        grid-template-columns: repeat(4, minmax(140px, 1fr));
        gap: 10px;
        margin-top: 14px;
      }

      .summary-box {
        background: linear-gradient(135deg, #ecf7ff, #e9f6f3);
        border: 1px solid #cde2f5;
        border-radius: 12px;
        padding: 10px;
        box-shadow: 0 10px 24px rgba(16, 40, 68, 0.09);
        animation: rise-in 0.55s ease both;
      }

      .summary-box .k {
        font-size: 11px;
        color: #355777;
      }

      .summary-box .v {
        margin-top: 4px;
        font-size: 20px;
        font-weight: 800;
        color: #123c5b;
      }

      .section {
        margin-top: 14px;
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 13px;
        background: linear-gradient(180deg, #ffffff, #f9fcff);
        box-shadow: 0 12px 28px rgba(18, 35, 62, 0.08);
      }

      .section h2 {
        margin: 0;
        font-size: 15px;
        font-family: "Sora", "Plus Jakarta Sans", sans-serif;
      }

      .section-sub {
        margin-top: 5px;
        color: var(--sub);
        font-size: 12px;
      }

      label {
        font-size: 12px;
        font-weight: 600;
        color: var(--sub);
        margin-bottom: 5px;
        display: block;
      }

      input,
      select,
      textarea,
      button {
        width: 100%;
        border-radius: 11px;
        border: 1px solid var(--line);
        padding: 10px 11px;
        font-size: 14px;
        font-family: inherit;
      }

      input,
      select,
      textarea {
        background: #ffffff;
        color: var(--text);
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #74a3de;
        box-shadow: 0 0 0 4px rgba(30, 64, 175, 0.1);
      }

      textarea {
        resize: vertical;
        min-height: 130px;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .grid-4 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 10px;
      }

      .actions {
        margin-top: 10px;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        gap: 8px;
      }

      .btn {
        cursor: pointer;
        border: 1px solid var(--line);
        background: linear-gradient(135deg, #ffffff, #f4f9ff);
        color: #20344b;
        font-weight: 600;
        transition: transform 0.18s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      }

      .btn:hover:not(:disabled) {
        transform: translateY(-1px);
        border-color: #aac3e0;
        box-shadow: 0 10px 24px rgba(20, 44, 73, 0.14);
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--brand), #0d9488);
        border-color: #0c776f;
        color: #fff;
      }

      .btn-soft {
        background: linear-gradient(135deg, #ebf7ff, #e8f7f3);
        border-color: #beddf1;
        color: #0f5371;
      }

      .btn-danger {
        background: linear-gradient(135deg, #fff1f1, #ffeaea);
        border-color: #f4c2c2;
        color: #bd2626;
      }

      .btn:disabled {
        cursor: not-allowed;
        opacity: 0.6;
        box-shadow: none;
        transform: none;
      }

      .bulk-note {
        margin-top: 8px;
        font-size: 12px;
        color: #4f6179;
        background: #f5f9ff;
        border: 1px dashed #cad9ec;
        border-radius: 11px;
        padding: 9px;
      }

      .table-tools {
        margin-top: 10px;
      }

      .table-filter-row {
        margin-top: 8px;
        display: grid;
        grid-template-columns: minmax(220px, 320px);
      }

      .table-wrap {
        margin-top: 8px;
        border: 1px solid #cfdbeb;
        border-radius: 12px;
        overflow: auto;
        background: #fff;
        box-shadow: 0 10px 24px rgba(20, 38, 63, 0.08);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
        min-width: 980px;
      }

      th,
      td {
        border-bottom: 1px solid #ecf1f8;
        padding: 9px 8px;
        text-align: left;
        vertical-align: top;
      }

      th {
        background: #edf4ff;
        color: #395675;
        font-weight: 700;
        position: sticky;
        top: 0;
        z-index: 1;
      }

      tbody tr:hover {
        background: #f8fbff;
      }

      .mini-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 6px;
      }

      .status {
        margin-top: 12px;
        min-height: 18px;
        font-size: 12px;
        font-weight: 600;
      }

      .status.ok {
        color: var(--ok);
      }

      .status.err {
        color: var(--error);
      }

      .warn {
        margin-top: 10px;
        font-size: 12px;
        color: #8f5b00;
        background: var(--warn-bg);
        border: 1px solid var(--warn-line);
        border-radius: 11px;
        padding: 10px;
        display: none;
      }

      @keyframes rise-in {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 1020px) {
        .summary,
        .grid-4,
        .actions {
          grid-template-columns: 1fr 1fr;
        }
      }

      @media (max-width: 760px) {
        .summary,
        .grid-2,
        .grid-4,
        .actions {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Manajemen Produk</h1>
      <div class="sub">CRUD produk lengkap: tambah, ubah, hapus, dan input multi data dalam satu kali simpan.</div>

      <div class="summary">
        <div class="summary-box">
          <div class="k">Total Produk</div>
          <div class="v" id="sumProduk">0</div>
        </div>
        <div class="summary-box">
          <div class="k">Alert Stok Minimum</div>
          <div class="v" id="sumLowStock">0</div>
        </div>
        <div class="summary-box">
          <div class="k">Alert Harga / Margin</div>
          <div class="v" id="sumPricing">0</div>
        </div>
        <div class="summary-box">
          <div class="k">Total Modal (Stok Akhir)</div>
          <div class="v" id="sumModalStokAkhir">Rp0</div>
        </div>
      </div>

      <div class="section">
        <h2>Form Produk (Single CRUD)</h2>
        <div class="section-sub">Isi form berikut untuk create/update produk. SKU yang sudah ada akan di-update.</div>

        <div class="grid-2" style="margin-top:10px;">
          <div>
            <label for="editSkuSelect">Pilih SKU untuk Edit Cepat</label>
            <select id="editSkuSelect">
              <option value="">Pilih SKU...</option>
            </select>
          </div>
          <div>
            <label for="search">Cari di Tabel Produk</label>
            <input id="search" type="text" placeholder="Cari SKU / nama / kategori..." autocomplete="off" />
          </div>
        </div>

        <div class="grid-4" style="margin-top:10px;">
          <div>
            <label for="sku">SKU</label>
            <input id="sku" type="text" placeholder="Contoh: BRS-003" autocomplete="off" />
          </div>
          <div>
            <label for="namaProduk">Nama Produk</label>
            <input id="namaProduk" type="text" placeholder="Nama barang" autocomplete="off" />
          </div>
          <div>
            <label for="kategori">Kategori</label>
            <input id="kategori" type="text" placeholder="Contoh: Beras" autocomplete="off" />
          </div>
          <div>
            <label for="satuan">Satuan</label>
            <input id="satuan" type="text" placeholder="pcs / kg / sak" autocomplete="off" />
          </div>
          <div>
            <label for="hargaModal">Harga Modal (Rp)</label>
            <input id="hargaModal" type="number" min="0" step="0.01" placeholder="0" />
          </div>
          <div>
            <label for="hargaJual">Harga Jual (Rp)</label>
            <input id="hargaJual" type="number" min="0" step="0.01" placeholder="0" />
          </div>
          <div>
            <label for="stokAwal">Stok Awal</label>
            <input id="stokAwal" type="number" min="0" step="0.01" placeholder="0" />
          </div>
          <div>
            <label for="stokMinimum">Stok Minimum</label>
            <input id="stokMinimum" type="number" min="0" step="0.01" placeholder="0" />
          </div>
        </div>

        <div class="actions">
          <button id="btnSaveProduct" class="btn btn-primary" type="button">Simpan (Create / Update)</button>
          <button id="btnResetForm" class="btn" type="button">Reset Form</button>
          <button id="btnDeleteProduct" class="btn btn-danger" type="button" disabled>Hapus SKU</button>
          <button id="btnReloadProducts" class="btn btn-soft" type="button">Reload Data</button>
        </div>
      </div>

      <div class="section">
        <h2>Input Multi Data Produk (Batch)</h2>
        <div class="section-sub">Satu baris = satu produk. Pisahkan kolom dengan titik koma `;`, tab, atau `|`.</div>

        <label for="bulkInput" style="margin-top:10px;">Format: SKU;Kategori;Nama Produk;Harga Modal;Satuan;Harga Jual;Stok Awal;Stok Minimum</label>
        <textarea id="bulkInput" placeholder="BRS-003;Beras;Beras Premium 2kg;25000;sak;31000;40;10"></textarea>

        <div class="actions">
          <button id="btnSaveBulk" class="btn btn-primary" type="button">Simpan Batch Produk</button>
          <button id="btnBulkTemplate" class="btn" type="button">Isi Contoh Template</button>
          <div></div>
          <div></div>
        </div>

        <div class="bulk-note">
          Contoh 2 baris:
          <br />
          BRS-003;Beras;Beras Premium 2kg;25000;sak;31000;40;10
          <br />
          MYK-002;Minyak;Minyak Goreng 2L;28500;pcs;34000;30;8
        </div>
      </div>

      <div class="section">
        <h2>Daftar Produk</h2>
        <div class="table-tools">
          <div class="table-filter-row">
            <div>
              <label for="tableCategoryFilter">Filter Kategori</label>
              <select id="tableCategoryFilter">
                <option value="">Semua Kategori</option>
              </select>
            </div>
          </div>
          <div class="section-sub">Klik Edit untuk memuat data ke form, atau Hapus untuk delete langsung.</div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>SKU</th>
                <th>Nama Produk</th>
                <th>Kategori</th>
                <th>Satuan</th>
                <th>Harga Modal</th>
                <th>Harga Jual</th>
                <th>Stok Awal</th>
                <th>Stok Akhir</th>
                <th>Stok Min</th>
                <th>Aksi</th>
              </tr>
            </thead>
            <tbody id="productTableBody"></tbody>
          </table>
        </div>
      </div>

      <div class="status" id="status"></div>
      <div class="warn" id="warn"></div>
    </div>

    <script>
      let products = [];
      let productMap = {};
      let isLoading = false;

      const API_BASE_STORAGE_KEY = 'paketsembako_api_base';
      const API_BASE = resolveApiBase_();

      function init() {
        document.getElementById('btnReloadProducts').addEventListener('click', function () {
          loadProducts();
        });
        document.getElementById('btnResetForm').addEventListener('click', function () {
          resetProductForm_(false);
        });
        document.getElementById('btnSaveProduct').addEventListener('click', saveSingleProduct_);
        document.getElementById('btnDeleteProduct').addEventListener('click', function () {
          deleteProductFromForm_(false);
        });
        document.getElementById('btnSaveBulk').addEventListener('click', saveBatchProducts_);
        document.getElementById('btnBulkTemplate').addEventListener('click', fillBulkTemplate_);
        document.getElementById('editSkuSelect').addEventListener('change', onSelectEditSku_);
        document.getElementById('search').addEventListener('input', renderProductTable_);
        document.getElementById('tableCategoryFilter').addEventListener('change', renderProductTable_);
        document.getElementById('productTableBody').addEventListener('click', onProductTableAction_);

        if (!isAppsScriptRuntime_() && !API_BASE) {
          setLoading(true);
          setStatus(
            'Runtime Apps Script tidak terdeteksi. Tambahkan ?apiBase=<URL_WEB_APP_APPS_SCRIPT>/exec pada URL halaman ini.',
            true
          );
          renderWarnings_([
            'Mode Netlify membutuhkan endpoint API Apps Script.',
            'Tambahkan query ?apiBase=<URL_WEB_APP_APPS_SCRIPT>/exec pada URL halaman ini.',
          ]);
          return;
        }

        loadProducts();
      }

      function loadProducts(successMessage) {
        setStatus('Memuat data produk...', false);
        setLoading(true);

        callBackend_(
          'getProductCrudData',
          null,
          function (payload) {
            setLoading(false);
            renderProductData_(payload || {});
            setStatus(successMessage || 'Data produk siap digunakan.', false);
          },
          function (error) {
            setLoading(false);
            setStatus('Gagal memuat data produk: ' + extractError(error), true);
          }
        );
      }

      function renderProductData_(payload) {
        products = Array.isArray(payload.items) ? payload.items : [];
        productMap = {};
        products.forEach(function (item) {
          productMap[item.sku] = item;
        });

        const summary = payload.summary || {};
        document.getElementById('sumProduk').textContent = formatNumber(summary.totalProduk || products.length || 0);
        document.getElementById('sumLowStock').textContent = formatNumber(summary.totalLowStock || 0);
        document.getElementById('sumPricing').textContent = formatNumber(summary.totalPricingAlerts || 0);
        document.getElementById('sumModalStokAkhir').textContent = formatCurrency(summary.totalModalStokAkhir || 0);

        renderWarnings_(payload.warnings || []);
        populateEditSkuSelect_();
        populateTableCategoryFilter_();
        renderProductTable_();

        const currentSku = normalizeSkuText_(document.getElementById('sku').value);
        if (currentSku && productMap[currentSku]) {
          fillProductForm_(productMap[currentSku], true);
        }
      }

      function populateEditSkuSelect_() {
        const select = document.getElementById('editSkuSelect');
        const selected = select.value;
        select.innerHTML = '';

        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = products.length ? 'Pilih SKU...' : 'Produk belum tersedia';
        select.appendChild(defaultOpt);

        products.forEach(function (item) {
          const opt = document.createElement('option');
          opt.value = item.sku;
          opt.textContent = item.sku + ' - ' + item.namaProduk;
          select.appendChild(opt);
        });

        if (selected && productMap[selected]) {
          select.value = selected;
        }
      }

      function populateTableCategoryFilter_() {
        const select = document.getElementById('tableCategoryFilter');
        const selected = safeText_(select.value);
        const categorySet = {};

        products.forEach(function (item) {
          const kategori = safeText_(item.kategori);
          if (kategori) {
            categorySet[kategori] = true;
          }
        });

        const categories = Object.keys(categorySet).sort(function (a, b) {
          return a.localeCompare(b, 'id', { sensitivity: 'base' });
        });

        select.innerHTML = '';

        const defaultOpt = document.createElement('option');
        defaultOpt.value = '';
        defaultOpt.textContent = 'Semua Kategori';
        select.appendChild(defaultOpt);

        categories.forEach(function (kategori) {
          const opt = document.createElement('option');
          opt.value = kategori;
          opt.textContent = kategori;
          select.appendChild(opt);
        });

        if (selected && categories.indexOf(selected) > -1) {
          select.value = selected;
        }
      }

      function renderProductTable_() {
        const tbody = document.getElementById('productTableBody');
        const keyword = safeText_(document.getElementById('search').value).toLowerCase();
        const categoryFilter = safeText_(document.getElementById('tableCategoryFilter').value).toLowerCase();
        const rows = products.filter(function (item) {
          const keywordMatch = !keyword || (
            safeText_(item.sku).toLowerCase().indexOf(keyword) > -1 ||
            safeText_(item.namaProduk).toLowerCase().indexOf(keyword) > -1 ||
            safeText_(item.kategori).toLowerCase().indexOf(keyword) > -1
          );
          const categoryMatch = !categoryFilter || safeText_(item.kategori).toLowerCase() === categoryFilter;
          return keywordMatch && categoryMatch;
        });

        tbody.innerHTML = '';
        if (!rows.length) {
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="10">Data produk tidak ditemukan.</td>';
          tbody.appendChild(tr);
          updateActionState_();
          return;
        }

        rows.forEach(function (item) {
          const tr = document.createElement('tr');
          tr.innerHTML =
            '<td>' + escapeHtml(item.sku) + '</td>' +
            '<td>' + escapeHtml(item.namaProduk || '-') + '</td>' +
            '<td>' + escapeHtml(item.kategori || '-') + '</td>' +
            '<td>' + escapeHtml(item.satuan || '-') + '</td>' +
            '<td>' + formatCurrency(item.hargaModal || 0) + '</td>' +
            '<td>' + formatCurrency(item.hargaJual || 0) + '</td>' +
            '<td>' + formatNumber(item.stokAwal || 0) + '</td>' +
            '<td>' + formatNumber(item.stokAkhir || 0) + '</td>' +
            '<td>' + formatNumber(item.stokMinimum || 0) + '</td>' +
            '<td><div class="mini-actions">' +
            '<button class="btn btn-soft" type="button" data-action="edit" data-sku="' + escapeHtml(item.sku) + '">Edit</button>' +
            '<button class="btn btn-danger" type="button" data-action="delete" data-sku="' + escapeHtml(item.sku) + '">Hapus</button>' +
            '</div></td>';
          tbody.appendChild(tr);
        });

        updateActionState_();
      }

      function onProductTableAction_(event) {
        const btn = event.target.closest('button[data-action]');
        if (!btn || isLoading) {
          return;
        }

        const action = btn.getAttribute('data-action');
        const sku = normalizeSkuText_(btn.getAttribute('data-sku'));
        if (!sku) {
          return;
        }

        if (action === 'edit') {
          const item = productMap[sku];
          if (!item) {
            setStatus('SKU tidak ditemukan: ' + sku, true);
            return;
          }
          fillProductForm_(item, false);
          return;
        }

        if (action === 'delete') {
          document.getElementById('sku').value = sku;
          deleteProductFromForm_(false);
        }
      }

      function onSelectEditSku_() {
        const sku = normalizeSkuText_(document.getElementById('editSkuSelect').value);
        if (!sku) {
          return;
        }
        const item = productMap[sku];
        if (!item) {
          setStatus('SKU tidak ditemukan: ' + sku, true);
          return;
        }
        fillProductForm_(item, false);
      }

      function fillProductForm_(item, silent) {
        if (!item) {
          return;
        }
        document.getElementById('sku').value = item.sku || '';
        document.getElementById('namaProduk').value = item.namaProduk || '';
        document.getElementById('kategori').value = item.kategori || '';
        document.getElementById('satuan').value = item.satuan || '';
        document.getElementById('hargaModal').value = Number(item.hargaModal || 0);
        document.getElementById('hargaJual').value = Number(item.hargaJual || 0);
        document.getElementById('stokAwal').value = Number(item.stokAwal || 0);
        document.getElementById('stokMinimum').value = Number(item.stokMinimum || 0);

        const select = document.getElementById('editSkuSelect');
        if (item.sku && productMap[item.sku]) {
          select.value = item.sku;
        }

        document.getElementById('btnDeleteProduct').disabled = false;
        if (!silent) {
          setStatus('Mode edit aktif untuk SKU ' + item.sku + '.', false);
        }
      }

      function resetProductForm_(silent) {
        document.getElementById('sku').value = '';
        document.getElementById('namaProduk').value = '';
        document.getElementById('kategori').value = '';
        document.getElementById('satuan').value = '';
        document.getElementById('hargaModal').value = '';
        document.getElementById('hargaJual').value = '';
        document.getElementById('stokAwal').value = '';
        document.getElementById('stokMinimum').value = '';
        document.getElementById('editSkuSelect').value = '';
        document.getElementById('btnDeleteProduct').disabled = true;
        if (!silent) {
          setStatus('Form produk direset.', false);
        }
      }

      function saveSingleProduct_() {
        let payload;
        try {
          payload = collectSingleFormPayload_();
        } catch (err) {
          setStatus(err.message || String(err), true);
          return;
        }

        setStatus('Menyimpan produk...', false);
        setLoading(true);

        callBackend_(
          'saveProductItem',
          payload,
          function (res) {
            const info = (res && res.product) || payload;
            loadProducts('Produk ' + info.sku + ' berhasil disimpan.');
          },
          function (error) {
            setLoading(false);
            setStatus('Gagal simpan produk: ' + extractError(error), true);
          }
        );
      }

      function deleteProductFromForm_(forceDelete) {
        const sku = normalizeSkuText_(document.getElementById('sku').value);
        if (!sku) {
          setStatus('Isi SKU yang ingin dihapus.', true);
          return;
        }

        if (!forceDelete) {
          const ok = window.confirm('Hapus SKU ' + sku + '?');
          if (!ok) {
            return;
          }
        }

        setStatus('Menghapus produk...', false);
        setLoading(true);

        callBackend_(
          'deleteProductItem',
          {
            sku: sku,
            forceDelete: !!forceDelete,
          },
          function (res) {
            resetProductForm_(true);
            const deletedSku = (res && res.deletedSku) || sku;
            loadProducts('SKU ' + deletedSku + ' berhasil dihapus.');
          },
          function (error) {
            const message = extractError(error);

            if (!forceDelete && shouldForceDeleteRetry_(message)) {
              const ok = window.confirm(
                'SKU ini sudah punya histori transaksi/mutasi.\nLanjutkan force delete? (data histori tetap ada, produk master dihapus)'
              );
              if (ok) {
                deleteProductFromForm_(true);
                return;
              }
            }

            setLoading(false);
            setStatus('Gagal hapus produk: ' + message, true);
          }
        );
      }

      function saveBatchProducts_() {
        const text = document.getElementById('bulkInput').value;
        let items;
        try {
          items = parseBulkProducts_(text);
        } catch (err) {
          setStatus(err.message || String(err), true);
          return;
        }

        if (!items.length) {
          setStatus('Tidak ada baris batch yang valid.', true);
          return;
        }

        setStatus('Menyimpan batch produk...', false);
        setLoading(true);

        callBackend_(
          'saveProductBatch',
          { items: items },
          function (res) {
            const created = Number((res && res.createdCount) || 0);
            const updated = Number((res && res.updatedCount) || 0);
            document.getElementById('bulkInput').value = '';
            loadProducts('Batch tersimpan. Create: ' + formatNumber(created) + ', Update: ' + formatNumber(updated) + '.');
          },
          function (error) {
            const message = extractError(error);
            if (isBatchActionUnsupported_(message)) {
              saveBatchFallbackOneByOne_(items);
              return;
            }
            setLoading(false);
            setStatus('Gagal simpan batch: ' + message, true);
          }
        );
      }

      function saveBatchFallbackOneByOne_(items) {
        const rows = Array.isArray(items) ? items : [];
        if (!rows.length) {
          setLoading(false);
          setStatus('Fallback batch gagal: data kosong.', true);
          return;
        }

        setStatus('Endpoint batch belum tersedia. Fallback simpan per item sedang berjalan...', false);

        let index = 0;
        let created = 0;
        let updated = 0;
        const failures = [];

        function next() {
          if (index >= rows.length) {
            document.getElementById('bulkInput').value = '';
            if (failures.length) {
              setLoading(false);
              setStatus(
                'Batch fallback selesai dengan kegagalan: ' + failures.length + ' baris. Contoh: ' + failures[0],
                true
              );
              return;
            }
            loadProducts(
              'Batch tersimpan via fallback. Create: ' + formatNumber(created) + ', Update: ' + formatNumber(updated) + '.'
            );
            return;
          }

          const currentRowNumber = index + 1;
          const item = rows[index];
          index += 1;

          callBackend_(
            'saveProductItem',
            item,
            function (res) {
              const action = safeText_(res && res.action).toLowerCase();
              if (action === 'created') {
                created += 1;
              } else {
                updated += 1;
              }
              next();
            },
            function (error) {
              failures.push('Baris ' + currentRowNumber + ': ' + extractError(error));
              next();
            }
          );
        }

        next();
      }

      function collectSingleFormPayload_() {
        const sku = normalizeSkuText_(document.getElementById('sku').value);
        const namaProduk = safeText_(document.getElementById('namaProduk').value);
        const kategori = safeText_(document.getElementById('kategori').value) || 'Umum';
        const satuan = safeText_(document.getElementById('satuan').value) || 'pcs';
        const hargaModal = toNumberInput_(document.getElementById('hargaModal').value);
        const hargaJual = toNumberInput_(document.getElementById('hargaJual').value);
        const stokAwal = toNumberInput_(document.getElementById('stokAwal').value);
        const stokMinimum = toNumberInput_(document.getElementById('stokMinimum').value);

        if (!sku) {
          throw new Error('SKU wajib diisi.');
        }
        if (!namaProduk) {
          throw new Error('Nama produk wajib diisi.');
        }
        if (hargaModal < 0 || hargaJual < 0 || stokAwal < 0 || stokMinimum < 0) {
          throw new Error('Harga/stok tidak boleh negatif.');
        }

        return {
          sku: sku,
          namaProduk: namaProduk,
          kategori: kategori,
          satuan: satuan,
          hargaModal: hargaModal,
          hargaJual: hargaJual,
          stokAwal: stokAwal,
          stokMinimum: stokMinimum,
        };
      }

      function parseBulkProducts_(text) {
        const lines = String(text || '').split(/\r?\n/);
        const items = [];
        let hasAnyData = false;

        lines.forEach(function (lineRaw, index) {
          const line = safeText_(lineRaw);
          if (!line) {
            return;
          }
          hasAnyData = true;

          let delimiter = '';
          if (line.indexOf('\t') > -1) {
            delimiter = '\t';
          } else if (line.indexOf(';') > -1) {
            delimiter = ';';
          } else if (line.indexOf('|') > -1) {
            delimiter = '|';
          }

          if (!delimiter) {
            throw new Error('Baris ke-' + (index + 1) + ' tidak punya pemisah. Gunakan ;, tab, atau |.');
          }

          const parts = line.split(delimiter).map(function (cell) {
            return safeText_(cell);
          });

          if (parts.length < 8) {
            throw new Error('Baris ke-' + (index + 1) + ' minimal harus 8 kolom.');
          }

          const firstCell = normalizeHeaderText_(parts[0]);
          if (firstCell === 'sku' || firstCell === 'id sku' || firstCell === 'id / sku') {
            return;
          }

          items.push({
            sku: parts[0],
            kategori: parts[1],
            namaProduk: parts[2],
            hargaModal: parts[3],
            satuan: parts[4],
            hargaJual: parts[5],
            stokAwal: parts[6],
            stokMinimum: parts[7],
          });
        });

        if (!hasAnyData) {
          throw new Error('Textarea batch masih kosong.');
        }

        return items;
      }

      function fillBulkTemplate_() {
        document.getElementById('bulkInput').value =
          'SKU;Kategori;Nama Produk;Harga Modal;Satuan;Harga Jual;Stok Awal;Stok Minimum\n' +
          'BRS-003;Beras;Beras Premium 2kg;25000;sak;31000;40;10\n' +
          'MYK-002;Minyak;Minyak Goreng 2L;28500;pcs;34000;30;8';
        setStatus('Template batch diisi. Sesuaikan data lalu klik "Simpan Batch Produk".', false);
      }

      function shouldForceDeleteRetry_(message) {
        const text = safeText_(message).toLowerCase();
        return text.indexOf('forcedelete') > -1 || text.indexOf('histori') > -1 || text.indexOf('dipakai') > -1;
      }

      function isBatchActionUnsupported_(message) {
        const text = safeText_(message).toLowerCase();
        return text.indexOf('action post tidak dikenal: save-products-batch') > -1 ||
          text.indexOf('action post tidak dikenal: save-product-batch') > -1 ||
          text.indexOf('action post tidak dikenal: upsert-products-batch') > -1 ||
          text.indexOf('fungsi backend tidak dikenali: saveproductbatch') > -1;
      }

      function renderWarnings_(warnings) {
        const box = document.getElementById('warn');
        if (!warnings || !warnings.length) {
          box.style.display = 'none';
          box.textContent = '';
          return;
        }

        box.style.display = 'block';
        box.innerHTML = warnings.map(function (w) { return '- ' + escapeHtml(w); }).join('<br>');
      }

      function callBackend_(functionName, payload, onSuccess, onFailure) {
        if (isAppsScriptRuntime_()) {
          callAppsScript_(functionName, payload, onSuccess, onFailure);
          return;
        }

        const success = typeof onSuccess === 'function' ? onSuccess : function () {};
        const failure = typeof onFailure === 'function' ? onFailure : function () {};

        if (!API_BASE) {
          failure(new Error('API endpoint belum diset. Tambahkan ?apiBase=<URL_WEB_APP_APPS_SCRIPT>/exec.'));
          return;
        }

        callApi_(functionName, payload).then(success).catch(failure);
      }

      function callApi_(functionName, payload) {
        if (functionName === 'getProductCrudData') {
          return fetchApi_('product-crud-data', 'GET');
        }
        if (functionName === 'saveProductItem') {
          return fetchApi_('save-product', 'POST', payload || {});
        }
        if (functionName === 'deleteProductItem') {
          return fetchApi_('delete-product', 'POST', payload || {});
        }
        if (functionName === 'saveProductBatch') {
          return fetchApi_('save-products-batch', 'POST', payload || {});
        }
        return Promise.reject(new Error('Fungsi backend tidak dikenali: ' + functionName));
      }

      async function fetchApi_(action, method, payload) {
        const url = new URL(API_BASE);
        url.searchParams.set('action', action);

        const options = {
          method: method,
          cache: 'no-store',
        };

        if (method === 'POST') {
          options.headers = { 'Content-Type': 'text/plain;charset=utf-8' };
          options.body = JSON.stringify(payload || {});
        }

        const response = await fetch(url.toString(), options);
        let json;

        try {
          json = await response.json();
        } catch (err) {
          throw new Error('Respons API tidak valid (bukan JSON).');
        }

        if (!response.ok) {
          throw new Error('HTTP ' + response.status + ' ' + response.statusText);
        }

        if (!json || json.ok !== true) {
          throw new Error((json && json.error) || 'Permintaan API gagal.');
        }

        return json.data;
      }

      function callAppsScript_(functionName, payload, onSuccess, onFailure) {
        if (!isAppsScriptRuntime_()) {
          onFailure(new Error('google.script.run tidak tersedia pada context ini.'));
          return;
        }

        const success = typeof onSuccess === 'function' ? onSuccess : function () {};
        const failure = typeof onFailure === 'function' ? onFailure : function () {};
        const runner = google.script.run
          .withSuccessHandler(success)
          .withFailureHandler(failure);

        if (typeof runner[functionName] !== 'function') {
          failure(new Error('Fungsi server tidak ditemukan: ' + functionName));
          return;
        }

        if (payload === null || payload === undefined) {
          runner[functionName]();
        } else {
          runner[functionName](payload);
        }
      }

      function resolveApiBase_() {
        const queryApi = sanitizeApiBase_(new URL(window.location.href).searchParams.get('apiBase'));
        if (queryApi) {
          try {
            localStorage.setItem(API_BASE_STORAGE_KEY, queryApi);
          } catch (err) {
            // Abaikan jika storage tidak tersedia.
          }
          return queryApi;
        }

        const windowApi = sanitizeApiBase_(window.APP_API_BASE);
        if (windowApi) {
          try {
            localStorage.setItem(API_BASE_STORAGE_KEY, windowApi);
          } catch (err) {
            // Abaikan jika storage tidak tersedia.
          }
          return windowApi;
        }

        try {
          return sanitizeApiBase_(localStorage.getItem(API_BASE_STORAGE_KEY));
        } catch (err) {
          return '';
        }
      }

      function sanitizeApiBase_(value) {
        const text = value === null || value === undefined ? '' : String(value).trim();
        if (!text) {
          return '';
        }
        return text.replace(/\/+$/, '');
      }

      function isAppsScriptRuntime_() {
        return typeof google !== 'undefined' && google && google.script && google.script.run;
      }

      function setLoading(loading) {
        isLoading = !!loading;
        updateActionState_();
      }

      function updateActionState_() {
        document.getElementById('btnReloadProducts').disabled = isLoading;
        document.getElementById('btnResetForm').disabled = isLoading;
        document.getElementById('btnSaveProduct').disabled = isLoading;
        document.getElementById('btnDeleteProduct').disabled = isLoading || !safeText_(document.getElementById('sku').value);
        document.getElementById('btnSaveBulk').disabled = isLoading;
        document.getElementById('btnBulkTemplate').disabled = isLoading;
        document.getElementById('editSkuSelect').disabled = isLoading;
        document.getElementById('search').disabled = isLoading;
        document.getElementById('tableCategoryFilter').disabled = isLoading;
      }

      function setStatus(message, isError) {
        const el = document.getElementById('status');
        el.textContent = message || '';
        el.className = 'status ' + (isError ? 'err' : 'ok');
      }

      function extractError(error) {
        if (!error) {
          return 'Unknown error';
        }
        return error.message || String(error);
      }

      function safeText_(value) {
        if (value === null || value === undefined) {
          return '';
        }
        return String(value).trim();
      }

      function normalizeSkuText_(value) {
        return safeText_(value).toUpperCase();
      }

      function normalizeHeaderText_(value) {
        return safeText_(value)
          .toLowerCase()
          .replace(/[\-_\/()]+/g, ' ')
          .replace(/\s+/g, ' ')
          .trim();
      }

      function toNumberInput_(value) {
        const raw = safeText_(value);
        if (!raw) {
          return 0;
        }

        let text = raw.replace(/\s+/g, '').replace(/[^0-9,.-]/g, '');
        if (!text) {
          return 0;
        }

        const hasComma = text.indexOf(',') > -1;
        const hasDot = text.indexOf('.') > -1;

        if (hasComma && hasDot) {
          if (text.lastIndexOf(',') > text.lastIndexOf('.')) {
            text = text.replace(/\./g, '').replace(',', '.');
          } else {
            text = text.replace(/,/g, '');
          }
        } else if (hasComma && !hasDot) {
          const parts = text.split(',');
          if (parts.length === 2 && parts[1].length <= 2) {
            text = parts[0].replace(/\./g, '') + '.' + parts[1];
          } else {
            text = text.replace(/,/g, '');
          }
        } else {
          text = text.replace(/,/g, '');
        }

        const num = parseFloat(text);
        return Number.isFinite(num) ? num : 0;
      }

      function formatCurrency(value) {
        return new Intl.NumberFormat('id-ID', {
          style: 'currency',
          currency: 'IDR',
          maximumFractionDigits: 0,
        }).format(Number(value) || 0);
      }

      function formatNumber(value) {
        return new Intl.NumberFormat('id-ID', {
          maximumFractionDigits: 2,
        }).format(Number(value) || 0);
      }

      function escapeHtml(text) {
        return String(text)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>
