<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Paket Sembako</title>
    <style>
      :root {
        --bg: #f3f7fb;
        --panel: #ffffff;
        --line: #d8e2ef;
        --ink: #1b2533;
        --sub: #5f6f82;
        --brand: #0b7285;
        --brand-2: #1864ab;
        --ok: #2b8a3e;
        --warn: #b26a00;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, sans-serif;
        background: linear-gradient(180deg, #f9fcff 0%, var(--bg) 100%);
        color: var(--ink);
      }

      .container {
        width: 100%;
        max-width: 980px;
        margin: 0 auto;
        padding: 18px;
      }

      .hero {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 18px;
        margin-bottom: 14px;
      }

      .hero h1 {
        margin: 0;
        font-size: 24px;
      }

      .hero p {
        margin: 8px 0 0;
        font-size: 13px;
        color: var(--sub);
      }

      .actions {
        display: grid;
        grid-template-columns: repeat(4, minmax(140px, 1fr));
        gap: 10px;
        margin-top: 14px;
      }

      .btn {
        border: 1px solid var(--line);
        background: #fff;
        color: var(--ink);
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
      }

      .btn-primary {
        background: var(--brand);
        border-color: var(--brand);
        color: #fff;
      }

      .btn-secondary {
        background: var(--brand-2);
        border-color: var(--brand-2);
        color: #fff;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(3, minmax(150px, 1fr));
        gap: 10px;
        margin-bottom: 12px;
      }

      .stat {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 12px;
        padding: 12px;
      }

      .stat .k {
        font-size: 12px;
        color: var(--sub);
      }

      .stat .v {
        margin-top: 6px;
        font-size: 22px;
        font-weight: 800;
      }

      .panel {
        background: var(--panel);
        border: 1px solid var(--line);
        border-radius: 14px;
        padding: 14px;
      }

      .panel h2 {
        margin: 0 0 10px;
        font-size: 16px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 13px;
      }

      th,
      td {
        border-bottom: 1px solid #ebf0f6;
        padding: 9px 8px;
        text-align: left;
      }

      .status-ok {
        color: var(--ok);
        font-weight: 700;
      }

      .status-miss {
        color: #c92a2a;
        font-weight: 700;
      }

      .muted {
        color: var(--sub);
      }

      .warnings {
        margin-top: 10px;
        font-size: 12px;
        color: var(--warn);
        background: #fff8e1;
        border: 1px solid #f2d39c;
        border-radius: 10px;
        padding: 9px;
        display: none;
      }

      .footnote {
        margin-top: 10px;
        font-size: 12px;
        color: var(--sub);
      }

      @media (max-width: 760px) {
        .actions,
        .stats {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <main class="container">
      <section class="hero">
        <h1>Paket Sembako</h1>
        <p>Halaman utama web app untuk akses Kasir, Manajemen Produk, Dashboard, dan status koneksi data spreadsheet.</p>

        <div class="actions">
          <button id="btnKasir" class="btn btn-primary">Buka Kasir</button>
          <button id="btnProduk" class="btn">Manajemen Produk</button>
          <button id="btnDashboard" class="btn btn-secondary">Buka Dashboard</button>
          <button id="btnRefresh" class="btn">Refresh Status</button>
        </div>
      </section>

      <section class="stats">
        <article class="stat">
          <div class="k">Total Produk</div>
          <div class="v" id="statProduk">0</div>
        </article>
        <article class="stat">
          <div class="k">Total Transaksi</div>
          <div class="v" id="statTransaksi">0</div>
        </article>
        <article class="stat">
          <div class="k">Total Pelanggan</div>
          <div class="v" id="statPelanggan">0</div>
        </article>
      </section>

      <section class="panel">
        <h2>Status Koneksi Sheet</h2>
        <table>
          <thead>
            <tr>
              <th>Sheet</th>
              <th>Status</th>
              <th>Jumlah Data</th>
              <th>Last Row</th>
              <th>Last Col</th>
            </tr>
          </thead>
          <tbody id="sheetTbody"></tbody>
        </table>
        <div class="warnings" id="warningsBox"></div>
        <div class="footnote muted" id="metaInfo">Memuat status...</div>
      </section>
    </main>

    <script>
      const API_BASE_STORAGE_KEY = 'paketsembako_api_base';
      const API_BASE = resolveApiBase_();

      function init() {
        document.getElementById('btnKasir').addEventListener('click', function () {
          navigateToView_('kasir');
        });

        document.getElementById('btnProduk').addEventListener('click', function () {
          navigateToView_('produk');
        });

        document.getElementById('btnDashboard').addEventListener('click', function () {
          navigateToView_('dashboard');
        });

        document.getElementById('btnRefresh').addEventListener('click', function () {
          loadStatus();
        });

        if (!isAppsScriptRuntime_() && !API_BASE) {
          document.getElementById('metaInfo').textContent =
            'Mode Netlify aktif, tapi endpoint API belum diset. Tambahkan ?apiBase=<URL_WEB_APP_APPS_SCRIPT>/exec pada URL.';
          return;
        }

        loadStatus();
      }

      function loadStatus() {
        document.getElementById('metaInfo').textContent = 'Memuat status koneksi...';

        callStatusBackend_(
          function (payload) {
            renderStatus(payload || {});
          },
          function (error) {
            document.getElementById('metaInfo').textContent = 'Gagal memuat status: ' + extractError_(error);
          }
        );
      }

      function callStatusBackend_(onSuccess, onFailure) {
        if (isAppsScriptRuntime_()) {
          google.script.run
            .withSuccessHandler(onSuccess)
            .withFailureHandler(onFailure)
            .getAppConnectionStatus();
          return;
        }

        if (!API_BASE) {
          onFailure(new Error('API endpoint belum diset.'));
          return;
        }

        const url = new URL(API_BASE);
        url.searchParams.set('action', 'status');
        fetchApiJson_(url.toString(), { method: 'GET', cache: 'no-store' })
          .then(onSuccess)
          .catch(onFailure);
      }

      function renderStatus(payload) {
        const stats = payload.stats || {};
        const sheets = payload.sheets || {};
        const meta = payload.meta || {};

        document.getElementById('statProduk').textContent = formatNumber_(stats.totalProduk || 0);
        document.getElementById('statTransaksi').textContent = formatNumber_(stats.totalTransaksi || 0);
        document.getElementById('statPelanggan').textContent = formatNumber_(stats.totalPelanggan || 0);

        const tbody = document.getElementById('sheetTbody');
        tbody.innerHTML = '';

        ['PRODUK', 'PENJUALAN', 'MUTASI_STOK', 'REKAP_PRODUK', 'REKAP_PELANGGAN'].forEach(function (sheetName) {
          const info = sheets[sheetName] || {};
          const tr = document.createElement('tr');
          tr.innerHTML =
            '<td>' + sheetName + '</td>' +
            '<td class=\"' + (info.exists ? 'status-ok' : 'status-miss') + '\">' + (info.exists ? 'Terhubung' : 'Tidak Ada') + '</td>' +
            '<td>' + formatNumber_(info.rowCount || 0) + '</td>' +
            '<td>' + formatNumber_(info.lastRow || 0) + '</td>' +
            '<td>' + formatNumber_(info.lastColumn || 0) + '</td>';
          tbody.appendChild(tr);
        });

        const warningsBox = document.getElementById('warningsBox');
        if (meta.warnings && meta.warnings.length) {
          warningsBox.style.display = 'block';
          warningsBox.innerHTML = meta.warnings.map(function (w) { return '- ' + escapeHtml_(w); }).join('<br>');
        } else {
          warningsBox.style.display = 'none';
          warningsBox.textContent = '';
        }

        const stamp = meta.generatedAt ? new Date(meta.generatedAt) : null;
        const stampText = stamp && !Number.isNaN(stamp.getTime())
          ? stamp.toLocaleString('id-ID')
          : '-';
        document.getElementById('metaInfo').textContent =
          'Spreadsheet: ' + (meta.spreadsheetName || '-') +
          ' | Timezone: ' + (meta.timezone || '-') +
          ' | Update: ' + stampText;
      }

      function navigateToView_(view) {
        if (isAppsScriptRuntime_()) {
          window.location.href = withViewParam_(view);
          return;
        }

        let fileName = 'Dashboard.html';
        if (view === 'kasir') {
          fileName = 'Kasir.html';
        } else if (view === 'produk') {
          fileName = 'Produk.html';
        }
        const url = new URL(fileName, window.location.href);
        if (API_BASE) {
          url.searchParams.set('apiBase', API_BASE);
        }
        window.location.href = url.toString();
      }

      function withViewParam_(view) {
        const url = new URL(window.location.href);
        url.searchParams.set('view', view);
        return url.toString();
      }

      async function fetchApiJson_(url, options) {
        const response = await fetch(url, options || {});
        let json;

        try {
          json = await response.json();
        } catch (err) {
          throw new Error('Respons API tidak valid (bukan JSON).');
        }

        if (!response.ok) {
          throw new Error('HTTP ' + response.status + ' ' + response.statusText);
        }

        if (!json || json.ok !== true) {
          throw new Error((json && json.error) || 'Permintaan API gagal.');
        }

        return json.data;
      }

      function resolveApiBase_() {
        const queryApi = sanitizeApiBase_(new URL(window.location.href).searchParams.get('apiBase'));
        if (queryApi) {
          try {
            localStorage.setItem(API_BASE_STORAGE_KEY, queryApi);
          } catch (err) {
            // Abaikan jika storage tidak tersedia.
          }
          return queryApi;
        }

        const windowApi = sanitizeApiBase_(window.APP_API_BASE);
        if (windowApi) {
          try {
            localStorage.setItem(API_BASE_STORAGE_KEY, windowApi);
          } catch (err) {
            // Abaikan jika storage tidak tersedia.
          }
          return windowApi;
        }

        try {
          return sanitizeApiBase_(localStorage.getItem(API_BASE_STORAGE_KEY));
        } catch (err) {
          return '';
        }
      }

      function sanitizeApiBase_(value) {
        const text = value === null || value === undefined ? '' : String(value).trim();
        if (!text) {
          return '';
        }
        return text.replace(/\/+$/, '');
      }

      function isAppsScriptRuntime_() {
        return typeof google !== 'undefined' && google && google.script && google.script.run;
      }

      function extractError_(error) {
        if (!error) {
          return 'Unknown error';
        }
        return error.message || String(error);
      }

      function formatNumber_(value) {
        return new Intl.NumberFormat('id-ID', { maximumFractionDigits: 0 }).format(Number(value) || 0);
      }

      function escapeHtml_(text) {
        return String(text)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/\"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      document.addEventListener('DOMContentLoaded', init);
    </script>
  </body>
</html>
